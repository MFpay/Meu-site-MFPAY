<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>MFpay | Dashboard Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background: #0b0e11; color: #fff; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .sidebar { background: #111418; border-right: 1px solid #1c2127; height: 100vh; position: fixed; width: 260px; padding: 40px 25px; }
        .main { margin-left: 260px; padding: 60px; }
        .card-fintech { background: #161a1e; border: 1px solid #232a31; border-radius: 24px; padding: 30px; transition: 0.3s; position: relative; overflow: hidden; }
        .card-fintech:hover { border-color: #333; transform: translateY(-3px); }
        .accent-bar { position: absolute; left: 0; top: 25%; height: 50%; width: 4px; border-radius: 0 4px 4px 0; }
        .nav-item { display: flex; align-items: center; gap: 12px; color: #555; font-size: 13px; font-weight: 700; padding: 14px; border-radius: 12px; cursor: pointer; transition: 0.3s; margin-bottom: 8px; }
        .nav-item:hover, .nav-item.active { background: #1c2127; color: #00e38c; }
        .input-dark { background: #0b0e11; border: 1px solid #232a31; color: #fff; border-radius: 14px; padding: 16px; outline: none; width: 100%; transition: 0.3s; font-weight: 600; }
        .input-dark:focus { border-color: #00e38c; }
    </style>
</head>
<body>

    <aside class="sidebar flex flex-col">
        <div class="flex items-center gap-3 mb-16 px-2">
            <div class="p-2 bg-[#00e38c]/10 rounded-lg"><i data-lucide="zap" class="text-[#00e38c] w-6 h-6"></i></div>
            <h1 class="text-[#00e38c] font-black italic text-2xl tracking-tighter">MFPAY</h1>
        </div>

        <nav class="flex-1">
            <div class="nav-item active"><i data-lucide="layout-dashboard" class="w-5 h-5"></i> FINANCEIRO</div>
            <div class="nav-item"><i data-lucide="arrow-up-right" class="w-5 h-5"></i> TRANSAÇÕES</div>
            
            <div id="mestre-ctrl" class="hidden mt-10 pt-10 border-t border-zinc-900">
                <button id="btn-mt" onclick="toggleMt()" class="w-full py-3 border border-blue-900 text-blue-500 rounded-xl text-[10px] font-black uppercase hover:bg-blue-900/10 transition">REDE ONLINE</button>
            </div>
        </nav>

        <div onclick="logout()" class="nav-item text-red-900 mt-auto"><i data-lucide="log-out" class="w-5 h-5"></i> SAIR</div>
    </aside>

    <main class="main">
        <header class="mb-12 flex justify-between items-center">
            <div>
                <h2 class="text-4xl font-black italic tracking-tight">Console</h2>
                <div class="flex items-center gap-2 mt-2">
                    <div id="avatar" class="w-6 h-6 rounded-full bg-[#00e38c] flex items-center justify-center text-[10px] text-black font-black uppercase"></div>
                    <p class="text-zinc-500 text-xs font-bold uppercase tracking-widest" id="user-display">---</p>
                </div>
            </div>
            <div class="bg-[#161a1e] px-4 py-2 rounded-full border border-zinc-800 flex items-center gap-2">
                <span class="w-2 h-2 bg-[#00e38c] rounded-full animate-pulse"></span>
                <span class="text-[10px] font-black text-zinc-500 uppercase">Gateway Live</span>
            </div>
        </header>

        <div class="grid grid-cols-2 gap-8 mb-16">
            <div class="card-fintech">
                <div class="accent-bar bg-[#00e38c]"></div>
                <div class="flex justify-between items-start mb-4">
                    <p class="text-zinc-600 text-[10px] font-black uppercase tracking-widest">Saldo Disponível</p>
                    <i data-lucide="wallet" class="text-zinc-700 w-5 h-5"></i>
                </div>
                <h3 id="saldo-on" class="text-5xl font-black tracking-tighter italic">R$ 0,00</h3>
            </div>
            <div class="card-fintech opacity-40">
                <div class="accent-bar bg-[#f3ba2f]"></div>
                <div class="flex justify-between items-start mb-4">
                    <p class="text-zinc-600 text-[10px] font-black uppercase tracking-widest">Bloqueado</p>
                    <i data-lucide="clock" class="text-zinc-700 w-5 h-5"></i>
                </div>
                <h3 class="text-5xl font-black tracking-tighter italic text-zinc-500">R$ 0,00</h3>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-10">
            <div class="bg-[#161a1e] p-10 rounded-[32px] border border-zinc-800">
                <div class="flex items-center gap-3 mb-8">
                    <i data-lucide="arrow-down-circle" class="text-[#00e38c] w-6 h-6"></i>
                    <h4 class="text-xs font-black uppercase text-[#00e38c] tracking-[0.3em] italic">Cash-in PIX</h4>
                </div>
                <input type="number" id="v-dep" placeholder="0.00" class="input-dark text-3xl font-black mb-6">
                <button onclick="gerarCobranca()" class="w-full bg-[#00e38c] text-black font-black py-5 rounded-2xl uppercase italic text-xs tracking-widest hover:bg-[#00c479] transition shadow-lg shadow-[#00e38c]/5">Gerar Ordem de Pagamento</button>
            </div>

            <div class="bg-[#161a1e] p-10 rounded-[32px] border border-zinc-800">
                <div class="flex items-center gap-3 mb-8">
                    <i data-lucide="send" class="text-red-500 w-6 h-6"></i>
                    <h4 class="text-xs font-black uppercase text-red-500 tracking-[0.3em] italic">Cash-out PIX</h4>
                </div>
                <input type="text" id="pix-saque" placeholder="Chave de Destino" class="input-mf input-dark mb-4">
                <input type="number" id="v-saque" placeholder="0.00" class="input-mf input-dark mb-6">
                <button onclick="pedirSaque()" class="w-full bg-zinc-800 text-white font-black py-5 rounded-2xl uppercase italic text-xs tracking-widest hover:bg-zinc-700 transition">Solicitar Retirada</button>
            </div>
        </div>
    </main>

<script>
    lucide.createIcons();
    const API = "https://sheetdb.io/api/v1/n1iq28pv28d009pq";
    const user = localStorage.getItem('mf_user');
    const MESTRE = "zndohot@gmail.com";
    const CAKTO_ID = "L1rDTK0E0379elxfFSYvoTU5xQxBRBpZ5LA7KJZD";

    if(!user) window.location.href = 'index.html';
    document.getElementById('user-display').innerText = user;
    document.getElementById('avatar').innerText = user.substring(0,2);
    if(user === MESTRE) document.getElementById('mestre-ctrl').classList.remove('hidden');

    async function carregar() {
        try {
            const m_res = await fetch(`${API}/search?merchant=${MESTRE}&tipo=CONTROLE`);
            const m_data = await m_res.json();
            if(m_data.length > 0 && m_data[0].status === 'MANUTENCAO' && user !== MESTRE) {
                document.body.innerHTML = "<div class='h-screen flex items-center justify-center font-black italic text-zinc-900 text-5xl bg-black uppercase tracking-tighter'>MFPAY_SYSTEM_OFFLINE</div>";
                return;
            }
            if(m_data.length > 0 && m_data[0].status === 'MANUTENCAO') {
                const b = document.getElementById('btn-mt'); b.innerText = "MANUTENÇÃO ATIVA"; b.style.color = "#ef4444"; b.style.borderColor = "#441111";
            }

            const res = await fetch(`${API}/search?merchant=${user}&status=Aprovado`);
            const data = await res.json();
            let bal = 0;
            data.forEach(i => { 
                if(i.tipo === 'DEPOSITO') bal += parseFloat(i.valor); 
                if(i.tipo === 'SAQUE') bal -= parseFloat(i.valor);
            });
            document.getElementById('saldo-on').innerText = `R$ ${bal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        } catch(e) {}
    }

    async function gerarCobranca() {
        const v = document.getElementById('v-dep').value;
        const tid = "DEP-" + Date.now();
        if(!v || v <= 0) return;
        await fetch(API, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ data: [{ id: tid, merchant: user, tipo: 'DEPOSITO', valor: v, status: 'Pendente', data_hora: new Date().toLocaleString() }] })
        });
        window.location.href = `https://pay.cakto.com.br/checkout?client_id=${CAKTO_ID}&value=${v}&external_id=${tid}`;
    }

    async function pedirSaque() {
        const v = parseFloat(document.getElementById('v-saque').value);
        const pix = document.getElementById('pix-saque').value;
        const saldoAt = parseFloat(document.getElementById('saldo-on').innerText.replace('R$ ', '').replace('.', '').replace(',', '.'));
        if(!v || v <= 0 || !pix || v > saldoAt) return alert("Verifique os dados ou saldo.");
        await fetch(API, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ data: [{ id: "SAQUE-" + Date.now(), merchant: user, tipo: 'SAQUE', valor: v, status: 'Pendente', data_hora: new Date().toLocaleString(), observacao: "PIX: " + pix }] })
        });
        alert("Solicitação de saque em processamento."); location.reload();
    }

    async function toggleMt() {
        const s = document.getElementById('btn-mt').innerText.includes("ONLINE") ? "MANUTENCAO" : "ONLINE";
        await fetch(`${API}/merchant/${MESTRE}`, {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ data: { status: s, tipo: 'CONTROLE' } })
        });
        location.reload();
    }

    function logout() { localStorage.clear(); window.location.href = 'index.html'; }
    carregar(); setInterval(carregar, 15000);
</script>
</body>
</html>
