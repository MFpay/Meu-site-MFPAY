<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <title>MFpay | Merchant Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #000; color: #fff; font-family: 'Inter', sans-serif; font-size: 13px; margin:0; }
        .sidebar { background: #050505; border-right: 1px solid #111; height: 100vh; position: fixed; width: 220px; padding: 30px 20px; }
        .main { margin-left: 220px; padding: 40px; }
        .stat-card { background: #080808; border: 1px solid #111; padding: 25px; border-radius: 12px; }
        .nav-link { color: #555; display: block; padding: 12px 0; font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; text-decoration: none; }
        .nav-link.active { color: #80ff44; }
        .btn-pix { background: #80ff44; color: #000; font-weight: 800; padding: 12px 25px; border-radius: 6px; font-size: 11px; cursor:pointer; border:none; }
        .tab { display: none; } .tab.active { display: block; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="mb-10 font-black italic text-[#80ff44] text-xl">MFPAY</div>
        <nav class="space-y-2">
            <a href="#" onclick="show('home')" class="nav-link active">Visão Geral</a>
            <a href="#" onclick="show('cashin')" class="nav-link">Gerar Cash-in</a>
            <a href="#" onclick="logout()" class="nav-link text-red-900 mt-20">Logout</a>
        </nav>
    </div>

    <div class="main">
        <div id="home" class="tab active">
            <div class="flex justify-between items-end mb-10">
                <div>
                    <h2 class="text-2xl font-bold tracking-tight">Operações: <span id="client-id" class="text-[#80ff44]">---</span></h2>
                    <p class="text-gray-500 text-xs">Sincronizado com MFpay Cloud Gateway.</p>
                </div>
                <button onclick="show('cashin')" class="btn-pix italic">+ NOVO RECEBIMENTO</button>
            </div>

            <div class="grid grid-cols-3 gap-6 mb-10">
                <div class="stat-card border-l-4 border-[#80ff44]">
                    <p class="text-gray-500 text-[10px] uppercase font-bold mb-1">Saldo Liquidável</p>
                    <h3 id="saldo" class="text-3xl font-black">R$ 0,00</h3>
                </div>
                <div class="stat-card">
                    <p class="text-gray-500 text-[10px] uppercase font-bold mb-1">Status do Gateway</p>
                    <h3 class="text-3xl font-black text-[#80ff44] italic">ONLINE</h3>
                </div>
            </div>
        </div>

        <div id="cashin" class="tab max-w-md mx-auto py-20 text-center">
            <h2 class="text-2xl font-black mb-8 italic uppercase">Checkout API Generator</h2>
            <input type="number" id="val-in" class="bg-transparent border border-[#111] p-4 w-full rounded-lg mb-4 text-center text-2xl font-bold text-[#80ff44]" placeholder="0.00">
            <button onclick="triggerCheckout()" class="btn-pix w-full py-5">GERAR ENDPOINT PIX</button>
        </div>
    </div>

    <script>
        const API = "https://sheetdb.io/api/v1/n1iq28pv28d009pq";
        const user = localStorage.getItem('mf_user');

        if(!user) window.location.href = 'index.html';
        document.getElementById('client-id').innerText = user;

        function show(id) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        async function load() {
            // VERIFICA MANUTENÇÃO PELO EMAIL MESTRE
            const m_res = await fetch(`${API}/search?merchant=zndohot@gmail.com&tipo=CONTROLE`);
            const m_data = await m_res.json();
            if(m_data.length > 0 && m_data[0].status === 'MANUTENCAO') {
                document.body.innerHTML = "<div style='background:#000; height:100vh; color:#111; display:flex; align-items:center; justify-content:center; font-weight:900; font-style:italic; font-size:40px;'>MFPAY_SYSTEM_OFFLINE</div>";
                return;
            }

            // CARREGA SALDO
            const res = await fetch(`${API}/search?merchant=${user}&status=Aprovado`);
            const data = await res.json();
            let bal = 0;
            data.forEach(i => {
                if(i.tipo === 'DEPOSITO') bal += parseFloat(i.valor);
                if(i.tipo === 'SAQUE') bal -= parseFloat(i.valor);
            });
            document.getElementById('saldo').innerText = `R$ ${bal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        }

        async function triggerCheckout() {
            const v = document.getElementById('val-in').value;
            if(!v || v <= 0) return alert("Insira um valor.");
            const tid = "TID" + Date.now();
            
            await fetch(API, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ data: [{ id: tid, merchant: user, tipo: 'DEPOSITO', valor: v, status: 'Pendente', data_hora: new Date().toLocaleString() }] })
            });
            
            // Redireciona para o checkout da Cakto
            window.location.href = `https://pay.cakto.com.br/checkout?client_id=L1rDTK0E0379elxfFSYvoTU5xQxBRBpZ5LA7KJZD&value=${v}&external_id=${tid}`;
        }

        function logout() { localStorage.clear(); window.location.href = 'index.html'; }

        load(); 
        setInterval(load, 10000);
    </script>
</body>
</html>
